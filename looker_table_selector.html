<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://www.gstatic.com/looker/visualization_api.js"></script>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #dropdown { padding: 8px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 6px; font-size: 12px; }
    th { background: #eee; }
  </style>
</head>
<body>
<div id="dropdown"></div>
<div id="table-container"></div>

<script>
looker.plugins.visualizations.add({
  id: "tabela_seletiva",
  create: function(element, config) {
    element.innerHTML = `
      <div id="menu"></div>
      <div id="table"></div>
    `;
  },

  updateAsync: function(data, element, config, queryResponse, details, done) {

    // listagem de campos disponíveis
    const dims = queryResponse.fields.dimensions.map(d => d.name);
    const mets = queryResponse.fields.metrics.map(m => m.name);
    const allFields = dims.concat(mets);

    let selected = new Set(allFields);

    // montar menu
    const menu = document.getElementById("menu");
    menu.innerHTML = "";
    allFields.forEach(field => {
      const id = "chk_" + field.replace(/\W/g, "_");

      const chk = document.createElement("input");
      chk.type = "checkbox";
      chk.id = id;
      chk.checked = true;
      chk.addEventListener("change", () => {
        if (chk.checked) selected.add(field);
        else selected.delete(field);
        renderTable();
      });

      const label = document.createElement("label");
      label.htmlFor = id;
      label.innerText = field;

      menu.appendChild(chk);
      menu.appendChild(label);
      menu.appendChild(document.createElement("br"));
    });

    function renderTable() {
      const rows = data.tables.DEFAULT;
      const table = document.getElementById("table");
      table.innerHTML = "<table><thead></thead><tbody></tbody></table>";

      const head = table.querySelector("thead");
      const body = table.querySelector("tbody");

      // cabeçalho
      const trHead = document.createElement("tr");
      selected.forEach(f => {
        const th = document.createElement("th");
        th.innerText = f;
        trHead.appendChild(th);
      });
      head.appendChild(trHead);

      // linhas
      rows.forEach(row => {
        const tr = document.createElement("tr");
        selected.forEach(f => {
          const td = document.createElement("td");
          const dimIdx = dims.indexOf(f);
          const metIdx = mets.indexOf(f);

          let value = "";
          if (dimIdx >= 0) value = row.dimensions[dimIdx];
          if (metIdx >= 0) value = row.metrics[metIdx];

          td.innerText = value;
          tr.appendChild(td);
        });
        body.appendChild(tr);
      });
    }

    renderTable();
    done();
  }
});
</script>

</body>
</html>
